# 메모리 누수
## 이거 진짜 새는겁니까?
현재 시점(22.01.15), 이 서버는 카카오 이미지를 대신해서 받아오는 역할을 수행중이다. 일종의 세탁(?) 서버 역할에 호스팅은 Heroku를 통해 이루어지고 있는데, 자꾸 로그창에 이런 에러가 도배 되었다.
```
heroku[web.1]: Error R14 (Memory quota exceeded)
```
일단 메모리 할당량 초과인듯 해서, 서버 메모리 할당량부터 체크해봤다.
무료 서버의 메모리는 <strong>512MB</strong>라고 적혀있었고, <strong>VisualVM</strong>을 통해서 메모리 사용량도 관찰해 보았다. 코드도 찜찜한 부분은 전부 null처리도 해줬다. 근데 아무리 봐도 새는 곳이 안보인다. 가비지컬렉터도 멀쩡하게 돌고 있다. 무엇이 문제일까?

## 아스라이 스쳐간 에러를 기억하며
일단 저 에러에 대해 더 자세히 찾아본 결과 <strong>메모리가 부족해서 가상메모리를 사용하게 될 때</strong> 뜨는 로그라고 설명이 적혀 있었다.
헤로쿠 관련 파일 중에 서버에서 작동할 빌드 명령어를 설정해주는 Procfile 이라는 것이 있다. 그곳에 $JAVA_OPTS 라고 적어 놓은게 있었다.
```
## 바뀌기 전
web: java -Dserver.port=$PORT $JAVA_OPTS -jar build/libs/mapshotServer-0.0.1-SNAPSHOT.jar
```
앞쪽은 구글에서 복붙해온거라 추측이긴 했는데, 아마 $ 표시가 붙은게 어딘가 설정된 옵션을 가져오는 것이란 생각이 들었다. 그래서 저 옵션을 지우고, 수동으로 메모리 할당 관련 옵션을 추가해봤다.

```
## 바꾼 후
web: java -Dserver.port=$PORT -jar build/libs/mapshotServer-0.0.1-SNAPSHOT.jar -Xms256m -Xmx512m
```
아마 기본 옵션에 힙 할당 관련이 크게 잡혀서 가비지 컬렉터 작동 관련도 삐걱거린 것 같고, 저 옵션 추가 이후로는 무거운 작업을 할 때는 가끔 저 로그가 뜨긴 하지만 지속적으로 도배되는 상황은 이제 일어나지 않는다. 저 에러 로그가 버그란 말도 있고 해서 앞으로 더 지켜봐야 하겠지만, 당분간은 만나지 않길 바란다.
