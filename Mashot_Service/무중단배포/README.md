# 무중단배포
## 하나에 꽉꽉
처음에 프로젝트를 배포할 때는 하나의 패키지에 모든 코드가 들어있었다. 
하지만, 앞에 nginx를 두고 무중단배포를 구현하는데 고민할 거리가 좀 생겼다.


## 이게 의미가 있나?
무중단 배포의 의미는 사용자 서비스 이용의 연속성에 있다고 생각한다.
그런데 지금 내 서비스는, 게임 서비스처럼 특정한 상태를 지닌 놈이 존재한다.
크롬드라이버로 이미지를 제작해주는 코드였는데, 유저가 특정한 좌표와 지도의 상태, 종류 등등을
잠깐이나마 들고 있는 코드였다.
문제가 되는 상황은 이런 상황이었다.

```
1. 유저가 지도 제작 중, 개발자가 새 코드 배포
2. 지도 제작하던 1번 포트 jar 종료, 2번 포트 jar 실행됨
3. 유저는 에러 메세지 받음, 새로고침하면 사이트는 멀쩡
4. 무슨 상황인지 모른 채 지도 다시 제작  
```

이러면 무중단 배포의 의미가 없다고 생각했다.
그래서, 2가지 정도 아이디어를 고민해봤다.

## 마이크로 미들(?) 서비스 
고민한 아이디어는 크게 2가지였다.
1. view단 코드를 전부 nginx에게 위임, 필요한 정보는 전부 rest api 형식으로 별도 패키징해서 백단에서 던져주게 함
    - 위성 이미지 제작 패키지
    - DB 커넥션 패키지(공지사항)
    - admin 관련 패키지 등등...
2. 상태를 기준으로 패키지 분리
    - 위성 이미지 제작 패키지
    - 일반적인 페이지 생성 패키지

사실 1번으로 하고 싶긴 했는데, 저걸 구현하려면 다 갈아 엎어야 되는 상황이라, 엄두가 안났다.
그래서 적당히 현실과 타협한 2번의 방법을 선택하게 되었다.
현재 서비스 상태는 반중단배포(?) 상태이다.
그냥 동적 페이지 생성 담당인 jar는 무중단 배포로 돌아가고 있지만, 이미지 제작 담당 jar는 중단 후 배포 상태이다. 
사실 다시 생각해보면 유저가 이미지를 생성중인 상황일 때는 작업 완료 시그널을 기다리다가 nginx 내부 jar 포트를 변경하는 등 방법들이 있긴 했는데, 서버 여유 메모리나 cpu 사용량 등등 여러가지를 고려해 보면 이 방식이 일단은 최선인 것 같다.