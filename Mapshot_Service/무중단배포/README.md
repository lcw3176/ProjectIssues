# 무중단배포
## 하나에 꽉꽉
처음에 프로젝트를 배포할 때는 하나의 패키지에 모든 코드가 들어있었다. 
하지만, 앞에 nginx를 두고 무중단배포를 구현하는데 고민할 거리가 좀 생겼다.


## 이게 의미가 있나?
무중단 배포의 의미는 사용자 서비스 이용의 연속성에 있다고 생각한다.
그런데 지금 내 서비스는, 배포 시 연속성이 끊기는 지점이 발생했다.
크롬드라이버로 이미지를 제작해주는 코드였는데, 유저가 특정한 좌표와 지도의 종류 등의 정보로 위성 지도를 생성, 렌더링이 완료되면 유저에게 전달해 주는 코드였다.
문제가 되는 상황은 이런 상황이었다.

```
1. 유저가 지도 제작 중, 개발자가 새 코드 배포
2. 지도 제작중이던 1번 포트 jar 종료, 2번 포트 jar 실행됨
3. 유저는 에러 메세지 받음, 새로고침하면 사이트는 멀쩡
4. 무슨 상황인지 모른 채 지도 다시 제작  
```

이러면 무중단 배포의 의미가 없다고 생각했다.
그래서, 2가지 정도 아이디어를 고민해봤다.

## 나눔의 미학
고민한 아이디어는 크게 2가지였다.

```
1. 유저가 제작하던 지도의 정보를 별도의 DB에 저장  
    - 새로 배포된 패키지는 이미지 제작 중이던 유저가 존재하는 지 확인
2. 상태를 기준으로 패키지 분리
    - 위성 이미지 제작 패키지
    - 일반적인 페이지 생성 패키지
```

첫 번째 방법은 유저 대기시간이 너무 길어지는 단점이 있어서, 2번의 방법으로 선택하게 되었다.
현재 서비스 상태는 반중단배포(?) 상태이다.
그냥 동적 페이지 생성 담당인 jar는 무중단 배포로 돌아가고 있지만, 이미지 제작 담당 jar는 중단 후 배포 상태이다. 
물론 둘 다 무중단 배포로 구현은 가능하였으나, 지금까지의 경험상 일반적인 페이지 생성 담당 패키지의 코드 수정이 훨씬 잦았던 점과, 현재 서버 여유 메모리나 cpu 사용량의 한계 때문에 이미지 제작 api 서버는 동시에 2개 이상 인스턴스를 만들기에는 어려운 점 등등을 고려해 보면 현재의 방식이 맞다고 생각했다. 